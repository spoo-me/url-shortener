function showAuthError(a){const b=document.getElementById("authError");b&&(b.textContent=a,b.style.display="block")}function clearAuthError(){const a=document.getElementById("authError");a&&(a.textContent="",a.style.display="none")}function validateAuthPassword(a){var b=Math.max,c=Math.min;if(!a)return{isValid:!1,missingRequirements:["Password is required"],strengthScore:0};const d=[];let e=0;const f=8<=a.length,g=128>=a.length,h=/[A-Z]/.test(a),i=/[a-z]/.test(a),j=/[0-9]/.test(a),k=/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(a),l=/^[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`\s]+$/.test(a);f?e+=20:d.push("At least 8 characters"),g?e+=5:d.push("Maximum 128 characters"),h?e+=15:d.push("At least one uppercase letter"),i?e+=15:d.push("At least one lowercase letter"),j?e+=15:d.push("At least one number"),k?e+=15:d.push("At least one special character"),l?e+=5:d.push("Contains invalid characters"),f&&12<=a.length&&(e+=5),f&&16<=a.length&&(e+=5),/(.)\1{2,}/.test(a)&&(e-=15),/(012|123|234|345|456|567|678|789|890|abc|bcd|cde|def)/i.test(a)&&(e-=20);const m=[/password/i,/123456/i,/qwerty/i,/admin/i,/login/i,/welcome/i];for(const b of m)if(b.test(a)){e-=30;break}return e=b(0,c(100,e)),{isValid:0===d.length,missingRequirements:d,strengthScore:e}}function getStrengthLabel(a){return 20>a?"Very Weak":40>a?"Weak":60>a?"Fair":80>a?"Good":"Strong"}function getStrengthColor(a){return 20>a?"#ef4444":40>a?"#f97316":60>a?"#eab308":80>a?"#22c55e":"#16a34a"}function updatePasswordStrength(a){const b=document.getElementById("passwordStrengthContainer"),c=document.getElementById("passwordStrengthBar"),d=document.getElementById("passwordStrengthLabel"),e=document.getElementById("passwordRequirements");if("undefined"==typeof authMode||"register"!==authMode)return b&&(b.style.display="none"),e&&(e.style.display="none"),{isValid:!1,missingRequirements:[],strengthScore:0};if(!a||0===a.length)return b&&(b.style.display="none"),e&&(e.style.display="none"),{isValid:!1,missingRequirements:["Password is required"],strengthScore:0};b&&(b.style.display="block"),e&&(e.style.display="block");const f=validateAuthPassword(a);if(!f||"object"!=typeof f)return console.error("validateAuthPassword returned invalid object:",f),{isValid:!1,missingRequirements:[],strengthScore:0};const g=f.strengthScore||0;if(c){const a=getStrengthColor(g);c.style.width=`${g}%`,c.style.backgroundColor=a}if(d){const a=getStrengthLabel(g),b=getStrengthColor(g);d.textContent=a,d.style.color=b}if(e){const a=f&&f.missingRequirements?f.missingRequirements:[];0<a.length?(e.innerHTML=a.map(a=>`<li class="requirement-missing"><span class="requirement-icon">✗</span> ${a}</li>`).join(""),e.style.display="block"):e.style.display="none"}return f}function showPasswordRequirements(a){if(0!==a.length){const b=document.getElementById("authError");if(b){const c=a.map(a=>`<li style="margin: 4px 0;"><span style="color: #ef4444; margin-right: 8px;">✗</span>${a}</li>`).join("");b.innerHTML=`
            <div style="text-align: left;">
                <div style="margin-bottom: 8px; font-weight: 500;">Password requirements not met:</div>
                <ul style="margin: 0; padding-left: 0; list-style: none;">
                    ${c}
                </ul>
            </div>
        `,b.style.display="block"}}}async function authFetch(a,b){const c=b||{};c.credentials||(c.credentials="include");let d=await fetch(a,c);if(401!==d.status)return d;try{const b=await fetch("/auth/refresh",{method:"POST",credentials:"include"});return b.ok?(d=await fetch(a,c),d):d}catch(a){return d}}async function submitAuth(){const a=document.getElementById("authEmail").value.trim(),b=document.getElementById("authPassword").value,c=document.getElementById("authUserName"),d=c?c.value.trim():"",e="undefined"!=typeof authMode&&"register"===authMode;if(e){const a=validateAuthPassword(b);if(!a.isValid)return void showPasswordRequirements(a.missingRequirements)}const f=e?"/auth/register":"/auth/login",g=e?{email:a,password:b,user_name:d}:{email:a,password:b};try{const a=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(g)}),b=await a.json().catch(()=>({}));if(!a.ok)return void(b.missing_requirements&&0<b.missing_requirements.length?showPasswordRequirements(b.missing_requirements):showAuthError(b&&b.error||"Something went wrong"));closeAuthModal(),window.location.href="/dashboard"}catch(a){showAuthError("Something went wrong")}}async function logout(){try{const a=await fetch("/auth/logout",{method:"POST",credentials:"include"});await updateAuthNav(),a.ok&&(window.location.href="/")}catch(a){await updateAuthNav()}}async function updateAuthNav(){try{const a=await authFetch("/auth/me",{credentials:"include"}),b=a.ok;let c=null;if(b){const b=await a.json().catch(()=>({}));c=b&&b.user?b.user:null}const d=(a,b,c="contents")=>{const d=document.getElementById(a);d&&(d.style.display=b?c:"none")};if(d("nav-auth",!b),d("nav-profile",b),d("nav-dashboard-locked",!b),d("nav-dashboard",!1),d("nav-keys",!1),d("m-nav-auth-btn",!b,"block"),d("m-nav-dashboard",b),d("m-nav-keys",b),d("m-nav-logout",b),d("m-nav-profile",b,"block"),c){const a=c.user_name&&(c.user_name+"").trim()||(c.email?(c.email+"").split("@")[0]:"user"),b=(a=>{const b=a.split(" ").filter(a=>0<a.length);return 2<=b.length?(b[0][0]+b[b.length-1][0]).toUpperCase():a.substring(0,2).toUpperCase()})(a),d=document.querySelector(".navbar .profile-avatar-container");if(d){const e=d.querySelector("img"),f=d.querySelector("#profileInitials");e&&f&&(c.pfp&&c.pfp.url?(e.src=c.pfp.url,e.alt=a,e.style.display="block",f.style.display="none",e.onerror=function(){e.style.display="none",f.style.display="flex",f.textContent=b}):(e.style.display="none",f.style.display="flex",f.textContent=b))}const e=document.querySelector(".mobile-navbar .profile-avatar-container");if(e){const d=e.querySelector("img"),f=e.querySelector("#profileInitials");d&&f&&(c.pfp&&c.pfp.url?(d.src=c.pfp.url,d.alt=a,d.style.display="block",f.style.display="none",d.onerror=function(){d.style.display="none",f.style.display="flex",f.textContent=b}):(d.style.display="none",f.style.display="flex",f.textContent=b))}const f=document.getElementById("profileAvatar");if(f){const b=c.pfp&&c.pfp.url?c.pfp.url:`https://avatar.iran.liara.run/username?username=${encodeURIComponent(a)}`;f.src=b,f.alt=a,f.onerror=function(){`https://avatar.iran.liara.run/username?username=${encodeURIComponent(a)}`!==this.src&&(this.src=`https://avatar.iran.liara.run/username?username=${encodeURIComponent(a)}`)}}const g=document.getElementById("mProfileAvatar");if(g){const b=c.pfp&&c.pfp.url?c.pfp.url:`https://avatar.iran.liara.run/username?username=${encodeURIComponent(a)}`;g.src=b,g.alt=a,g.onerror=function(){`https://avatar.iran.liara.run/username?username=${encodeURIComponent(a)}`!==this.src&&(this.src=`https://avatar.iran.liara.run/username?username=${encodeURIComponent(a)}`)}}}window.authCheckComplete=!0,window.isLoggedIn=b,document.dispatchEvent(new CustomEvent("auth:init",{detail:{loggedIn:b,user:c}}))}catch(a){window.authCheckComplete=!0,window.isLoggedIn=!1,document.dispatchEvent(new CustomEvent("auth:init",{detail:{loggedIn:!1,user:null}}))}}document.addEventListener("DOMContentLoaded",function(){"function"==typeof updateAuthNav&&updateAuthNav();const a=document.getElementById("authPassword");a&&a.addEventListener("input",function(){handlePasswordInput(this.value)})});function handlePasswordInput(a){"undefined"!=typeof authMode&&"register"===authMode&&updatePasswordStrength(a)}