class UrlManager{constructor(){this.currentUrlData=null,this.hostUrl=window.dashboardConfig?.hostUrl||"",this.modal=document.getElementById("url-management-modal"),this.deleteModal=document.getElementById("delete-confirmation-modal"),this.form=document.getElementById("url-edit-form"),this.aliasInput=document.getElementById("edit-alias"),this.longUrlInput=document.getElementById("edit-long-url"),this.passwordInput=document.getElementById("edit-password"),this.removePasswordCheckbox=document.getElementById("remove-password-checkbox"),this.passwordStatus=document.getElementById("password-status"),this.privateStatsCheckbox=document.getElementById("edit-private-stats"),this.maxClicksInput=document.getElementById("edit-max-clicks"),this.expireAfterInput=document.getElementById("edit-expire-after"),this.blockBotsCheckbox=document.getElementById("edit-block-bots"),this.deactivateBtn=document.getElementById("btn-deactivate"),this.deleteBtn=document.getElementById("btn-delete-url"),this.saveBtn=document.getElementById("btn-save"),this.deleteUrlPreview=document.getElementById("delete-url-preview"),this.deleteConfirmationInput=document.getElementById("delete-confirmation-input"),this.cancelDeleteBtn=document.getElementById("btn-cancel-delete"),this.confirmDeleteBtn=document.getElementById("btn-confirm-delete"),this.init()}init(){this.initTabs(),this.modal?.querySelector(".modal-close")?.addEventListener("click",()=>this.closeModal()),this.modal?.querySelector(".modal-backdrop")?.addEventListener("click",()=>this.closeModal()),this.deactivateBtn?.addEventListener("click",()=>this.deactivateUrl()),this.deleteBtn?.addEventListener("click",()=>this.showDeleteConfirmation()),this.saveBtn?.addEventListener("click",()=>this.saveChanges()),this.removePasswordCheckbox?.addEventListener("change",()=>this.handlePasswordCheckboxChange()),this.deleteModal?.querySelector(".modal-close")?.addEventListener("click",()=>this.closeDeleteModal()),this.deleteModal?.querySelector(".modal-backdrop")?.addEventListener("click",()=>this.closeDeleteModal()),this.cancelDeleteBtn?.addEventListener("click",()=>this.closeDeleteModal()),this.confirmDeleteBtn?.addEventListener("click",()=>this.confirmDelete()),this.deleteConfirmationInput?.addEventListener("input",()=>this.validateDeleteInput()),this.form?.addEventListener("submit",a=>{a.preventDefault(),this.saveChanges()}),document.addEventListener("keydown",a=>{"Escape"===a.key&&(this.deleteModal?.classList.contains("active")?this.closeDeleteModal():this.modal?.classList.contains("active")&&this.closeModal())}),this.attachRowListeners()}initTabs(){if(!this.modal)return;const a=this.modal.querySelectorAll(".tab"),b=this.modal.querySelectorAll(".tab-content"),c=this.modal.querySelector(".tabs");a.forEach((d,e)=>{d.addEventListener("click",()=>{const f=d.getAttribute("data-tab");c&&c.setAttribute("data-active",e.toString()),a.forEach(a=>a.classList.remove("active")),d.classList.add("active"),b.forEach(a=>{a.classList.remove("active"),a.getAttribute("data-tab")===f&&a.classList.add("active")})})})}attachRowListeners(){document.addEventListener("click",a=>{const b=a.target.closest(".clickable-row");if(b){if(a.target.closest("a"))return;const c=b.getAttribute("data-url-data");if(c)try{const a=JSON.parse(c);this.editUrl(a)}catch(a){console.error("Error parsing URL data:",a)}}})}editUrl(a){this.currentUrlData=a,this.populateForm(a),this.showModal()}populateForm(a){if(this.aliasInput&&(this.aliasInput.value=a.alias||""),this.longUrlInput&&(this.longUrlInput.value=a.long_url||""),this.passwordInput&&(this.passwordInput.value=""),this.removePasswordCheckbox&&(this.removePasswordCheckbox.checked=!1,a.password_set?(this.removePasswordCheckbox.disabled=!1,this.passwordStatus&&(this.passwordStatus.textContent="Password is currently set")):(this.removePasswordCheckbox.disabled=!0,this.passwordStatus&&(this.passwordStatus.textContent="No password set"))),this.privateStatsCheckbox&&(this.privateStatsCheckbox.checked=a.private_stats||!1),this.maxClicksInput&&(this.maxClicksInput.value=a.max_clicks||""),this.expireAfterInput)if(a.expire_after){const b=new Date(1e3*a.expire_after);this.expireAfterInput.value=b.toISOString().slice(0,16)}else this.expireAfterInput.value="";this.blockBotsCheckbox&&(this.blockBotsCheckbox.checked=a.block_bots||!1),this.updateDeactivateButton(a.status)}handlePasswordCheckboxChange(){if(this.removePasswordCheckbox&&this.passwordInput)if(this.removePasswordCheckbox.checked)this.passwordInput.disabled=!0,this.passwordInput.value="",this.passwordInput.placeholder="Password will be removed",this.passwordStatus&&(this.passwordStatus.textContent="Password will be removed");else if(this.passwordInput.disabled=!1,this.passwordInput.placeholder="Enter new password",this.passwordStatus){const a=this.currentUrlData?.password_set;this.passwordStatus.textContent=a?"Password is currently set":"No password set"}}updateDeactivateButton(a){this.deactivateBtn&&("ACTIVE"===a?(this.deactivateBtn.innerHTML="<i class=\"ti ti-player-pause\"></i><span>Deactivate</span>",this.deactivateBtn.className="btn btn-warning"):(this.deactivateBtn.innerHTML="<i class=\"ti ti-player-play\"></i><span>Activate</span>",this.deactivateBtn.className="btn btn-success"))}showModal(){if(this.modal){this.modal.classList.add("active"),document.body.style.overflow="hidden";const a=this.modal.querySelector(".tabs");a&&a.setAttribute("data-active","0"),setTimeout(()=>{this.aliasInput?.focus()},400)}}closeModal(){this.modal&&(this.modal.classList.remove("active"),document.body.style.overflow="",this.currentUrlData=null)}async saveChanges(){var a=Math.floor;if(!this.currentUrlData)return;const b={};let c=!1;const d=this.aliasInput?.value?.trim();d&&d!==this.currentUrlData.alias&&(b.alias=d,c=!0);const e=this.longUrlInput?.value?.trim();if(e&&e!==this.currentUrlData.long_url&&(b.long_url=e,c=!0),this.removePasswordCheckbox?.checked)b.password=null,c=!0;else{const a=this.passwordInput?.value?.trim();a&&""!==a&&(b.password=a,c=!0)}const f=this.maxClicksInput?.value?.trim(),g=this.currentUrlData.max_clicks;""===f&&g?(b.max_clicks=null,c=!0):f&&parseInt(f)!==g&&(b.max_clicks=parseInt(f),c=!0);const h=this.expireAfterInput?.value,i=this.currentUrlData.expire_after;if(""===h&&i)b.expire_after=null,c=!0;else if(h){const d=a(new Date(h).getTime()/1e3);d!==i&&(b.expire_after=d,c=!0)}const j=this.privateStatsCheckbox?.checked||!1;j!==this.currentUrlData.private_stats&&(b.private_stats=j,c=!0);const k=this.blockBotsCheckbox?.checked||!1;if(k!==this.currentUrlData.block_bots&&(b.block_bots=k,c=!0),!c)return void this.showNotification("No changes detected","info");try{this.saveBtn.disabled=!0,this.saveBtn.innerHTML="<i class=\"ti ti-loader-2\"></i><span>Saving...</span>",console.log("Sending update data:",b);const a=await this.apiCall(`/api/v1/urls/${this.getUrlId()}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)});if(a.ok){const c=await a.json();this.currentUrlData={...this.currentUrlData,...c},this.removePasswordCheckbox?.checked?(this.currentUrlData.password_set=!1,this.passwordStatus&&(this.passwordStatus.textContent="No password set"),this.removePasswordCheckbox&&(this.removePasswordCheckbox.checked=!1,this.removePasswordCheckbox.disabled=!0),this.passwordInput&&(this.passwordInput.disabled=!1,this.passwordInput.placeholder="Enter new password")):b.password&&(this.currentUrlData.password_set=!0,this.passwordStatus&&(this.passwordStatus.textContent="Password is currently set"),this.removePasswordCheckbox&&(this.removePasswordCheckbox.disabled=!1),this.passwordInput&&(this.passwordInput.value="")),this.showNotification("URL updated successfully","success"),this.updateTableRow(this.currentUrlData),this.refreshUrlList(),setTimeout(()=>{this.closeModal()},200)}else{const b=await a.json();throw new Error(b.error||"Failed to update URL")}}catch(a){console.error("Error updating URL:",a),this.showNotification(a.message,"error")}finally{this.saveBtn.disabled=!1,this.saveBtn.innerHTML="<i class=\"ti ti-check\"></i><span>Save Changes</span>"}}async deactivateUrl(){if(!this.currentUrlData)return;const a=this.currentUrlData.status||"ACTIVE",b="ACTIVE"===a?"INACTIVE":"ACTIVE",c=this.deactivateBtn.innerHTML;try{this.deactivateBtn.disabled=!0,this.deactivateBtn.innerHTML="<i class=\"ti ti-loader-2\"></i><span>Processing...</span>";const a=await this.apiCall(`/api/v1/urls/${this.getUrlId()}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:b})});if(a.ok){this.currentUrlData.status=b,this.updateDeactivateButton(b);const a="ACTIVE"===b?"activated":"deactivated";this.showNotification(`URL ${a} successfully`,"success"),this.updateTableRow(this.currentUrlData),this.refreshUrlList()}else{const b=await a.json();throw new Error(b.error||"Failed to update URL status")}}catch(a){console.error("Error updating URL status:",a),this.showNotification(a.message,"error"),this.deactivateBtn.innerHTML=c}finally{this.deactivateBtn.disabled=!1}}showDeleteConfirmation(){if(this.currentUrlData){const a=`${this.hostUrl}${this.currentUrlData.alias}`;this.deleteUrlPreview&&(this.deleteUrlPreview.textContent=a),this.deleteConfirmationInput&&(this.deleteConfirmationInput.value=""),this.confirmDeleteBtn&&(this.confirmDeleteBtn.disabled=!0),this.deleteModal&&(this.deleteModal.classList.add("active"),setTimeout(()=>{this.deleteConfirmationInput?.focus()},100))}}closeDeleteModal(){this.deleteModal&&this.deleteModal.classList.remove("active")}validateDeleteInput(){if(!this.deleteConfirmationInput||!this.confirmDeleteBtn||!this.currentUrlData)return;const a=this.deleteConfirmationInput.value.trim(),b=this.currentUrlData.alias;this.confirmDeleteBtn.disabled=a!==b}async confirmDelete(){if(this.currentUrlData){const a=this.currentUrlData.alias;console.log("About to delete URL with alias:",a);try{this.confirmDeleteBtn.disabled=!0,this.confirmDeleteBtn.innerHTML="<i class=\"ti ti-loader-2\"></i><span>Deleting...</span>";const b=await this.apiCall(`/api/v1/urls/${this.getUrlId()}`,{method:"DELETE"});if(b.ok)this.showNotification("URL deleted successfully","success"),this.closeDeleteModal(),this.closeModal(),this.removeUrlFromTable(a),this.refreshUrlList();else{const a=await b.json();throw new Error(a.error||"Failed to delete URL")}}catch(a){console.error("Error deleting URL:",a),this.showNotification(a.message,"error")}finally{this.confirmDeleteBtn.disabled=!1,this.confirmDeleteBtn.innerHTML="<i class=\"ti ti-trash\"></i><span>Delete Permanently</span>"}}}viewStats(a){window.open(`/stats/${a}`,"_blank")}getUrlId(){return this.currentUrlData?.id}async apiCall(a,b={}){const c={credentials:"same-origin",headers:{Accept:"application/json",...b.headers}};return fetch(a,{...c,...b})}showNotification(a,b="info"){const c=document.createElement("div");if(c.className=`notification notification-${b}`,c.innerHTML=`
            <div class="notification-content">
                <i class="ti ti-${"success"===b?"check":"error"===b?"x":"info-circle"}"></i>
                <span>${a}</span>
            </div>
        `,!document.getElementById("notification-styles")){const a=document.createElement("style");a.id="notification-styles",a.textContent=`
                .notification {
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    background: rgba(255, 255, 255, 0.1);
                    backdrop-filter: blur(20px);
                    border-radius: 8px;
                    padding: 16px 20px;
                    color: white;
                    font-size: 14px;
                    font-weight: 500;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    border-left: 4px solid;
                }
                .notification-success { border-left-color: #10b981; }
                .notification-error { border-left-color: #ef4444; }
                .notification-info { border-left-color: #3b82f6; }
                .notification.show { transform: translateX(0); }
                .notification-content {
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }
            `,document.head.appendChild(a)}document.body.appendChild(c),setTimeout(()=>c.classList.add("show"),100),setTimeout(()=>{c.classList.remove("show"),setTimeout(()=>c.remove(),300)},3e3)}removeUrlFromTable(a){if(!a)return void console.error("No alias provided for removal");console.log("Removing URL from table:",a);const b=document.querySelectorAll(".clickable-row");let c=!1;b.forEach(b=>{const d=b.getAttribute("data-url-data");if(d)try{const e=JSON.parse(d);e.alias===a&&(c=!0,console.log("Found row to remove:",e),b.style.transition="all 0.3s ease",b.style.opacity="0",b.style.transform="translateX(-20px)",setTimeout(()=>{b.remove(),console.log("Row removed from DOM")},300))}catch(a){console.error("Error parsing URL data for removal:",a)}}),c||console.warn("No row found with alias:",a)}updateTableRow(a){const b=document.querySelectorAll(".clickable-row");b.forEach(b=>{const c=b.getAttribute("data-url-data");if(c)try{const d=JSON.parse(c);if(d.alias===a.alias||d.id===a.id){b.setAttribute("data-url-data",JSON.stringify(a));const c=b.querySelector(".link-long");c&&a.long_url&&(c.textContent=a.long_url,c.title=a.long_url);const d=b.querySelector(".link-short");if(d&&a.alias){const b=this.hostUrl.replace(/\/+$/,"")+"/";d.textContent=b.replace(/^https?:\/\//i,"")+a.alias,d.href="/"+a.alias}const e=b.querySelector(".badge-active"),f=b.querySelector(".badge-inactive");e&&f&&("ACTIVE"===a.status?(e.style.display="inline-flex",f.style.display="none"):"INACTIVE"===a.status?(e.style.display="none",f.style.display="inline-flex"):(e.style.display="none",f.style.display="none"));const g=b.querySelector(".badge-password");g&&(g.style.display=a.password_set?"inline-flex":"none");const h=b.querySelector(".badge-max-clicks");h&&(a.max_clicks?(h.style.display="inline-flex",h.setAttribute("data-tooltip",`Max clicks: ${a.max_clicks}`)):h.style.display="none");const i=b.querySelector(".badge-private");i&&(i.style.display=a.private_stats?"inline-flex":"none");const j=b.querySelector(".badge-block-bots");j&&(j.style.display=a.block_bots?"inline-flex":"none"),b.style.transition="all 0.3s ease",b.style.background="rgba(16, 185, 129, 0.1)",setTimeout(()=>{b.style.background=""},1e3)}}catch(a){console.error("Error parsing URL data for update:",a)}})}refreshUrlList(){window.fetchData&&"function"==typeof window.fetchData&&window.fetchData()}}document.addEventListener("DOMContentLoaded",()=>{window.urlManager=new UrlManager});