const keyElements={loading:document.getElementById("keys-loading"),empty:document.getElementById("keys-empty"),table:document.getElementById("keys-table"),list:document.getElementById("keys-list"),template:document.getElementById("tpl-key-item"),newKeyBtn:document.getElementById("btn-new-key"),createModal:document.getElementById("createKeyModal"),successModal:document.getElementById("keySuccessModal"),createBtn:document.getElementById("btn-create"),tokenInput:document.getElementById("fullTokenInput")};async function fetchKeys(){setKeysLoading(!0),keyElements.empty.style.display="none";try{const a=await authFetch("/api/v1/keys",{headers:{Accept:"application/json"}});if(!a.ok)throw new Error("Failed to fetch keys");const b=await a.json();renderKeys(b.keys||[])}catch(a){console.error("Error fetching keys:",a),showEmptyState()}finally{setKeysLoading(!1)}}function setKeysLoading(a){keyElements.loading.style.display=a?"flex":"none",a&&(keyElements.table.style.display="none",keyElements.empty.style.display="none")}function showEmptyState(){keyElements.empty.style.display="flex",keyElements.table.style.display="none"}function renderKeys(a){if(keyElements.list.innerHTML="",!a||0===a.length)return void showEmptyState();keyElements.table.style.display="block",keyElements.empty.style.display="none";const b=document.createDocumentFragment();a.forEach(a=>{const c=createKeyRow(a);b.appendChild(c)}),keyElements.list.appendChild(b)}function createKeyRow(a){const b=keyElements.template.content.firstElementChild.cloneNode(!0),c=b.querySelector(".key-name"),d=b.querySelector(".key-description");c.textContent=a.name||"(no name)",d.textContent=a.description||"",a.description||(d.style.display="none");const e=b.querySelector(".key-prefix");e.textContent=`spoo_${a.token_prefix||""}â€¦`;const f=b.querySelector(".scopes-list");a.scopes&&0<a.scopes.length?a.scopes.forEach(a=>{const b=document.createElement("span");b.className="scope-tag",b.textContent=a,f.appendChild(b)}):f.innerHTML="<span style=\"color: var(--text-secondary); font-style: italic;\">none</span>";const g=b.querySelector(".created-date"),h=b.querySelector(".expires-date");g.textContent=a.created_at?new Date(1e3*a.created_at).toLocaleDateString():"\u2014",h.textContent=a.expires_at?new Date(1e3*a.expires_at).toLocaleDateString():"Never";const i=b.querySelector(".status-badge"),j=a.revoked?"revoked":a.expires_at&&1e3*a.expires_at<Date.now()?"expired":"active";i.textContent=j.toUpperCase(),i.className=`status-badge status-${j}`;const k=b.querySelector(".btn-revoke");return k.disabled=a.revoked,k.textContent=a.revoked?"Deleted":"Delete",k.setAttribute("data-id",a.id),a.revoked||k.addEventListener("click",()=>revokeKey(a.id)),b}async function revokeKey(a){if(confirm("Delete this key permanently? This action cannot be undone."))try{const b=await authFetch(`/api/v1/keys/${a}`,{method:"DELETE",headers:{Accept:"application/json"}});if(b.ok){const a=await b.json().catch(()=>({})),c=a.action||"deleted";customTopNotification("KeyDeleted",`Key ${c} successfully`,6,"success"),fetchKeys()}else customTopNotification("KeyRevokeError","Failed to revoke key",8,"error")}catch(a){customTopNotification("KeyRevokeError","Failed to revoke key",8,"error")}}function openCreateKeyModal(){keyElements.createModal.style.display="flex",document.body.style.overflow="hidden",setTimeout(()=>{document.getElementById("key-name").focus()},100)}function closeCreateKeyModal(){keyElements.createModal.style.display="none",document.body.style.overflow="",resetCreateForm()}function openKeySuccessModal(a){closeCreateKeyModal(),keyElements.tokenInput.value=a,keyElements.successModal.style.display="flex",document.body.style.overflow="hidden",fetchKeys(),setTimeout(async()=>{try{await navigator.clipboard.writeText(a);const b=document.querySelector(".copy-btn i");b&&(b.className="ti ti-check",setTimeout(()=>{b.className="ti ti-copy"},2e3))}catch(a){console.log("Auto-copy failed, user can copy manually")}},100)}function closeKeySuccessModal(){keyElements.successModal.style.display="none",document.body.style.overflow="",fetchKeys()}function resetCreateForm(){document.getElementById("key-name").value="",document.getElementById("key-description").value="",document.getElementById("key-expires").value="",document.getElementById("full-access").checked=!0,document.getElementById("custom-access").checked=!1,document.querySelectorAll(".scope-input").forEach(a=>{a.checked="shorten:create"===a.value}),handleAccessLevelChange("full")}async function createKey(){const a=document.getElementById("key-name").value.trim(),b=document.getElementById("key-description").value.trim(),c=document.getElementById("key-expires").value,d=document.querySelector("input[name=\"access-level\"]:checked").value;let e;if(e="full"===d?["admin:all"]:Array.from(document.querySelectorAll(".scope-input:checked")).map(a=>a.value),!a||0===e.length)return void customTopNotification("KeyCreateError","Name and at least one permission are required",8,"error");const f={name:a,description:b||void 0,scopes:e,expires_at:c||void 0},g=keyElements.createBtn,h=g.innerHTML;g.disabled=!0,g.innerHTML="<i class=\"ti ti-loader\" style=\"animation: spin 1s linear infinite;\"></i> Creating...";try{const a=await authFetch("/api/v1/keys",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(f)}),b=await a.json().catch(()=>({}));if(!a.ok){if(closeCreateKeyModal(),"EMAIL_NOT_VERIFIED"===b.code)return void("function"==typeof showVerificationModal&&showVerificationModal("create API keys"));let c=b.error||"Failed to create key";return 429===a.status||c.toLowerCase().includes("ratelimit")?c="Rate limit exceeded. You can create up to 5 keys per hour. Please try again later.":c.includes("maximum")&&c.includes("active keys")&&(c="Maximum active keys limit reached (20). Please delete some unused keys first."),void customTopNotification("KeyCreateError",c,10,"error")}openKeySuccessModal(b.token,b.token_prefix)}catch(a){closeCreateKeyModal(),customTopNotification("KeyCreateError","Network error. Please try again.",8,"error")}finally{g.disabled=!1,g.innerHTML=h}}async function copyTokenToClipboard(){try{await navigator.clipboard.writeText(keyElements.tokenInput.value),customTopNotification("KeyCopied","API key copied to clipboard",5,"success");const a=document.querySelector(".copy-btn"),b=a.querySelector("i");b.className="ti ti-check",setTimeout(()=>{b.className="ti ti-copy"},2e3)}catch(a){customTopNotification("KeyCopyError","Failed to copy key",8,"error")}}function setupAccessLevelHandlers(){const a=document.querySelectorAll("input[name=\"access-level\"]"),b=document.getElementById("detailed-permissions"),c=document.querySelectorAll(".access-option");a.forEach(a=>{a.addEventListener("change",function(){handleAccessLevelChange(this.value)})});const d=document.querySelector("input[name=\"access-level\"]:checked")?.value||"full";handleAccessLevelChange(d)}function handleAccessLevelChange(a){const b=document.getElementById("detailed-permissions"),c=document.querySelectorAll(".scope-input");"full"===a?b.classList.add("hidden"):"custom"==a&&(setTimeout(()=>{b.classList.remove("hidden")},100),c.forEach(a=>{a.checked="shorten:create"===a.value}))}document.addEventListener("DOMContentLoaded",function(){fetchKeys(),keyElements.newKeyBtn?.addEventListener("click",openCreateKeyModal),keyElements.createBtn?.addEventListener("click",createKey),setupAccessLevelHandlers(),keyElements.createModal?.addEventListener("click",a=>{(a.target===keyElements.createModal||a.target.classList.contains("modal-overlay"))&&closeCreateKeyModal()}),keyElements.successModal?.addEventListener("click",a=>{(a.target===keyElements.successModal||a.target.classList.contains("modal-overlay"))&&closeKeySuccessModal()}),document.addEventListener("keydown",a=>{"Escape"===a.key&&("flex"===keyElements.createModal.style.display?closeCreateKeyModal():"flex"===keyElements.successModal.style.display&&closeKeySuccessModal())}),keyElements.tokenInput?.addEventListener("click",copyTokenToClipboard),document.getElementById("key-name")?.addEventListener("keydown",a=>{"Enter"===a.key&&createKey()})}),window.closeCreateKeyModal=closeCreateKeyModal,window.closeKeySuccessModal=closeKeySuccessModal,window.copyTokenToClipboard=copyTokenToClipboard;