const FILTER_TYPES=["browser","os","country","city","referrer","short_code"],TOP_N=7,COUNTRY_MAP={AD:"Andorra",AE:"United Arab Emirates",AF:"Afghanistan",AG:"Antigua and Barbuda",AI:"Anguilla",AL:"Albania",AM:"Armenia",AO:"Angola",AQ:"Antarctica",AR:"Argentina",AS:"American Samoa",AT:"Austria",AU:"Australia",AW:"Aruba",AX:"\xC5land Islands",AZ:"Azerbaijan",BA:"Bosnia and Herzegovina",BB:"Barbados",BD:"Bangladesh",BE:"Belgium",BF:"Burkina Faso",BG:"Bulgaria",BH:"Bahrain",BI:"Burundi",BJ:"Benin",BL:"Saint Barth\xE9lemy",BM:"Bermuda",BN:"Brunei",BO:"Bolivia",BQ:"Caribbean Netherlands",BR:"Brazil",BS:"Bahamas",BT:"Bhutan",BV:"Bouvet Island",BW:"Botswana",BY:"Belarus",BZ:"Belize",CA:"Canada",CC:"Cocos Islands",CD:"Democratic Republic of the Congo",CF:"Central African Republic",CG:"Republic of the Congo",CH:"Switzerland",CI:"C\xF4te d'Ivoire",CK:"Cook Islands",CL:"Chile",CM:"Cameroon",CN:"China",CO:"Colombia",CR:"Costa Rica",CU:"Cuba",CV:"Cape Verde",CW:"Cura\xE7ao",CX:"Christmas Island",CY:"Cyprus",CZ:"Czech Republic",DE:"Germany",DJ:"Djibouti",DK:"Denmark",DM:"Dominica",DO:"Dominican Republic",DZ:"Algeria",EC:"Ecuador",EE:"Estonia",EG:"Egypt",EH:"Western Sahara",ER:"Eritrea",ES:"Spain",ET:"Ethiopia",FI:"Finland",FJ:"Fiji",FK:"Falkland Islands",FM:"Micronesia",FO:"Faroe Islands",FR:"France",GA:"Gabon",GB:"United Kingdom",GD:"Grenada",GE:"Georgia",GF:"French Guiana",GG:"Guernsey",GH:"Ghana",GI:"Gibraltar",GL:"Greenland",GM:"Gambia",GN:"Guinea",GP:"Guadeloupe",GQ:"Equatorial Guinea",GR:"Greece",GS:"South Georgia",GT:"Guatemala",GU:"Guam",GW:"Guinea-Bissau",GY:"Guyana",HK:"Hong Kong",HM:"Heard Island",HN:"Honduras",HR:"Croatia",HT:"Haiti",HU:"Hungary",ID:"Indonesia",IE:"Ireland",IL:"Israel",IM:"Isle of Man",IN:"India",IO:"British Indian Ocean Territory",IQ:"Iraq",IR:"Iran",IS:"Iceland",IT:"Italy",JE:"Jersey",JM:"Jamaica",JO:"Jordan",JP:"Japan",KE:"Kenya",KG:"Kyrgyzstan",KH:"Cambodia",KI:"Kiribati",KM:"Comoros",KN:"Saint Kitts and Nevis",KP:"North Korea",KR:"South Korea",KW:"Kuwait",KY:"Cayman Islands",KZ:"Kazakhstan",LA:"Laos",LB:"Lebanon",LC:"Saint Lucia",LI:"Liechtenstein",LK:"Sri Lanka",LR:"Liberia",LS:"Lesotho",LT:"Lithuania",LU:"Luxembourg",LV:"Latvia",LY:"Libya",MA:"Morocco",MC:"Monaco",MD:"Moldova",ME:"Montenegro",MF:"Saint Martin",MG:"Madagascar",MH:"Marshall Islands",MK:"North Macedonia",ML:"Mali",MM:"Myanmar",MN:"Mongolia",MO:"Macao",MP:"Northern Mariana Islands",MQ:"Martinique",MR:"Mauritania",MS:"Montserrat",MT:"Malta",MU:"Mauritius",MV:"Maldives",MW:"Malawi",MX:"Mexico",MY:"Malaysia",MZ:"Mozambique",NA:"Namibia",NC:"New Caledonia",NE:"Niger",NF:"Norfolk Island",NG:"Nigeria",NI:"Nicaragua",NL:"Netherlands",NO:"Norway",NP:"Nepal",NR:"Nauru",NU:"Niue",NZ:"New Zealand",OM:"Oman",PA:"Panama",PE:"Peru",PF:"French Polynesia",PG:"Papua New Guinea",PH:"Philippines",PK:"Pakistan",PL:"Poland",PM:"Saint Pierre and Miquelon",PN:"Pitcairn Islands",PR:"Puerto Rico",PS:"Palestine",PT:"Portugal",PW:"Palau",PY:"Paraguay",QA:"Qatar",RE:"R\xE9union",RO:"Romania",RS:"Serbia",RU:"Russia",RW:"Rwanda",SA:"Saudi Arabia",SB:"Solomon Islands",SC:"Seychelles",SD:"Sudan",SE:"Sweden",SG:"Singapore",SH:"Saint Helena",SI:"Slovenia",SJ:"Svalbard and Jan Mayen",SK:"Slovakia",SL:"Sierra Leone",SM:"San Marino",SN:"Senegal",SO:"Somalia",SR:"Suriname",SS:"South Sudan",ST:"S\xE3o Tom\xE9 and Pr\xEDncipe",SV:"El Salvador",SX:"Sint Maarten",SY:"Syria",SZ:"Eswatini",TC:"Turks and Caicos Islands",TD:"Chad",TF:"French Southern Territories",TG:"Togo",TH:"Thailand",TJ:"Tajikistan",TK:"Tokelau",TL:"Timor-Leste",TM:"Turkmenistan",TN:"Tunisia",TO:"Tonga",TR:"Turkey",TT:"Trinidad and Tobago",TV:"Tuvalu",TW:"Taiwan",TZ:"Tanzania",UA:"Ukraine",UG:"Uganda",UM:"United States Minor Outlying Islands",US:"United States",UY:"Uruguay",UZ:"Uzbekistan",VA:"Vatican City",VC:"Saint Vincent and the Grenadines",VE:"Venezuela",VG:"British Virgin Islands",VI:"United States Virgin Islands",VN:"Vietnam",VU:"Vanuatu",WF:"Wallis and Futuna",WS:"Samoa",YE:"Yemen",YT:"Mayotte",ZA:"South Africa",ZM:"Zambia",ZW:"Zimbabwe",XX:"Unknown"},CHART_CONFIGS={browser:{id:"browserChart",metricBase:"browser",totalKey:"clicks_by_browser",uniqueKey:"unique_clicks_by_browser",totalLabel:"Browsers",uniqueLabel:"Unique Browsers",colors:{total:{bg:"rgba(59, 130, 246, 0.2)",border:"rgba(59, 130, 246, 0.9)"},unique:{bg:"rgba(147, 197, 253, 0.4)",border:"rgba(147, 197, 253, 1)"}},defaultMode:"compare"},os:{id:"osChart",metricBase:"os",totalKey:"clicks_by_os",uniqueKey:"unique_clicks_by_os",totalLabel:"Platforms",uniqueLabel:"Unique Platforms",colors:{total:{bg:"rgba(16, 185, 129, 0.2)",border:"rgba(16, 185, 129, 0.9)"},unique:{bg:"rgba(110, 231, 183, 0.4)",border:"rgba(110, 231, 183, 1)"}},defaultMode:"compare"},referrer:{id:"referrerChart",metricBase:"referrer",totalKey:"clicks_by_referrer",uniqueKey:"unique_clicks_by_referrer",totalLabel:"Referrers",uniqueLabel:"Unique Referrers",colors:{total:{bg:"rgba(245, 158, 11, 0.2)",border:"rgba(245, 158, 11, 0.9)"},unique:{bg:"rgba(252, 211, 77, 0.4)",border:"rgba(252, 211, 77, 1)"}},defaultMode:"compare"},city:{id:"cityChart",metricBase:"city",totalKey:"clicks_by_city",uniqueKey:"unique_clicks_by_city",totalLabel:"Cities",uniqueLabel:"Unique Cities",colors:{total:{bg:"rgba(239, 68, 68, 0.2)",border:"rgba(239, 68, 68, 0.9)"},unique:{bg:"rgba(252, 165, 165, 0.4)",border:"rgba(252, 165, 165, 1)"}},defaultMode:"compare"},short_code:{id:"keyChart",metricBase:"short_code",totalKey:"clicks_by_short_code",uniqueKey:"unique_clicks_by_short_code",totalLabel:"Total Clicks",uniqueLabel:"Unique Clicks",colors:{total:{bg:"rgba(139, 92, 246, 0.25)",border:"rgba(139, 92, 246, 1)"},unique:{bg:"rgba(196, 181, 253, 0.4)",border:"rgba(196, 181, 253, 1)"}},defaultMode:"compare",tooltipAfterBody(e,t){const a=e[0]?.dataIndex??-1;if(0>a)return"";const r=t.labels[a];if("Others"===r)return"";const i=t.datasets.find(e=>/Clicks/i.test(e.label));if(!i)return"";const l=i.data.reduce((e,t)=>e+t,0),n=i.data[a],s=0<l?(100*(n/l)).toFixed(1):0;return`\nPercentage: ${s}%`}}};function closeAllModals(e){const t=document.querySelector(".filters-dropdown");if(t){t.classList.remove("show");const e=document.querySelector(".filters-btn");e&&e.classList.remove("active")}const a=document.querySelector(".auto-refresh-btn"),r=a?.nextElementSibling;r&&(r.classList.remove("show"),a&&a.classList.remove("active"));const i=document.getElementById("exportDropdownMenu");if(i){i.classList.remove("active");const e=document.querySelector(".export-btn");e&&e.classList.remove("active")}document.querySelectorAll(".multi-select-dropdown").forEach(t=>{if(t.classList.contains("show")){t.classList.remove("show");const a=t.parentElement,r=a.querySelector(".multi-select-trigger");if(r&&r.classList.remove("active"),a.classList.remove("active"),e){const t=a.dataset.filter;e.pendingChanges&&e.pendingChanges.has(t)&&(e.pendingChanges.delete(t),e.filterManager&&e.filterManager.notifyChange())}}});const l=document.getElementById("dateRangeDropdown");if(l){l.style.display="none";const e=document.getElementById("dateRangeTrigger");e&&e.classList.remove("active")}}class StatisticsDashboard{constructor(){this.charts=new Map,this.currentTimeRange=null,this.startDate=null,this.endDate=null,this.refreshInterval=null,this.autoRefreshInterval=null,this.apiData=null,this.dateRangePicker=null,this.activeRequestController=null,this.filterManager=new FilterManager,this.availableOptions={browser:[],os:[],country:[],city:[],referrer:[],short_code:[]},this.pendingChanges=new Set,this.currentFilterType=null,this.init()}formatTimeLabel(e,t){if(!e)return e;try{const a=dayjs(e);return"10_minute"===t||"hourly"===t?a.format("h:mm A"):"daily"===t?a.format("MMM D"):"weekly"===t?`Week ${a.week()}`:"monthly"===t?a.format("MMM YYYY"):a.format("MMM D")}catch(t){return console.warn("Error formatting time label:",t),e}}getCountryName(e){return COUNTRY_MAP[e]||e}init(){this.setupDateRangePicker(),this.setupEventListeners(),this.setupFilterSystem(),this.loadDashboardData(),this.setupAutoRefresh(),this.restoreAutoRefreshSetting()}processTopDataWithOthers(e,t,a){if(!e||0===e.length)return{labels:[],values:[]};const r=[...e].sort((e,a)=>(a[t]||0)-(e[t]||0));if(r.length<=TOP_N)return{labels:r.map(e=>e[a]||"Unknown"),values:r.map(e=>e[t]||0)};const i=r.slice(0,TOP_N),l=r.slice(TOP_N),n=l.reduce((e,a)=>e+(a[t]||0),0),s=[...i.map(e=>e[a]||"Unknown"),"Others"],o=[...i.map(e=>e[t]||0),n];return{labels:s,values:o}}setupDateRangePicker(){this.dateRangePicker=new DateRangePicker({container:"dateRangeContainer",onRangeChange:e=>{this.handleDateRangeChange(e)},defaultRange:"last-7-days"})}handleDateRangeChange(e){this.startDate=e.start,this.endDate=e.end,this.currentTimeRange=e.range,this.loadDashboardData()}setupEventListeners(){const e=document.querySelector(".refresh-btn");e&&e.addEventListener("click",t=>{t.preventDefault(),this.loadDashboardData()});const t=document.querySelector(".auto-refresh-btn");t&&t.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const e=t.nextElementSibling;if(e&&e.classList.contains("dropdown-menu")){const a=e.classList.contains("show");closeAllModals(this),a||(e.classList.add("show"),t.classList.add("active"))}}),document.addEventListener("click",t=>{const e=t.target.closest(".auto-refresh-dropdown");if(!e){const e=document.querySelectorAll(".auto-refresh-dropdown .dropdown-menu.show"),t=document.querySelector(".auto-refresh-btn");e.forEach(e=>e.classList.remove("show")),t&&t.classList.remove("active")}}),this.setupTableViewControls(),this.setupCascadeControls()}setupFilterSystem(){const t=document.querySelector(".filters-btn"),a=document.querySelector(".filters-dropdown");t&&a&&t.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();const e=a.classList.contains("show");closeAllModals(this),e||(a.classList.add("show"),t.classList.add("active"))}),document.addEventListener("click",t=>{if(!t.target.closest(".filters-dropdown-container")){const e=document.querySelector(".filters-dropdown"),t=document.querySelector(".filters-btn");e&&t&&(e.classList.remove("show"),t.classList.remove("active"))}}),this.setupHierarchicalFilters(),this.filterManager.onFiltersChanged=()=>{this.updateFilterUI(),this.loadDashboardData()}}setupHierarchicalFilters(){const e=document.querySelectorAll(".filter-type-item:not(.clear-all-item)");e.forEach(t=>{t.addEventListener("click",a=>{a.preventDefault();const e=t.dataset.filter;this.showFilterValues(e)})});const t=document.querySelector(".filter-type-item.clear-all-item");t&&t.addEventListener("click",t=>{t.preventDefault(),this.filterManager.clearAllFilters(),this.closeFiltersDropdown()});const a=document.querySelector(".back-btn");a&&a.addEventListener("click",t=>{t.preventDefault(),this.currentFilterType&&this.pendingChanges.has(this.currentFilterType)&&(this.pendingChanges.delete(this.currentFilterType),this.filterManager.notifyChange()),this.showFilterTypes()});const r=document.querySelector(".values-search-input");r&&r.addEventListener("input",t=>{this.currentFilterType&&this.filterValuesOptions(this.currentFilterType,t.target.value)})}showFilterValues(e){this.currentFilterType=e;const t=document.querySelector(".filter-types-list"),a=document.querySelector(".filter-values-view"),r=document.querySelector(".back-btn");if(t&&a){t.classList.add("view-exit-active"),setTimeout(()=>{t.style.display="none",t.classList.remove("view-exit-active"),a.style.display="block",a.classList.add("view-enter"),a.offsetHeight,a.classList.add("view-enter-active"),a.classList.remove("view-enter"),setTimeout(()=>{a.classList.remove("view-enter-active")},200)},80),this.populateFilterValues(e);const i=a.querySelector(".values-search-input");i&&(i.value="",setTimeout(()=>i.focus(),100)),r&&this.setBackButtonApplyState(!1)}}showFilterTypes(){this.currentFilterType&&this.pendingChanges.has(this.currentFilterType)&&(this.pendingChanges.delete(this.currentFilterType),this.filterManager.notifyChange()),this.currentFilterType=null;const e=document.querySelector(".filter-types-list"),t=document.querySelector(".filter-values-view"),a=document.querySelector(".back-btn");e&&t&&(t.classList.add("view-exit-active"),setTimeout(()=>{t.style.display="none",t.classList.remove("view-exit-active"),e.style.display="block",e.classList.add("view-enter"),e.offsetHeight,e.classList.add("view-enter-active"),e.classList.remove("view-enter"),setTimeout(()=>{e.classList.remove("view-enter-active")},200)},80)),a&&this.setBackButtonApplyState(!1)}setBackButtonApplyState(e){const t=document.querySelector(".back-btn");if(t){const a=t.querySelector("i");a&&(e?(a.className="ti ti-check",t.title="Apply & Back"):(a.className="ti ti-arrow-left",t.title="Back"))}}closeFiltersDropdown(){const e=document.querySelector(".filters-dropdown"),t=document.querySelector(".filters-btn");e&&t&&(e.classList.remove("show"),t.classList.remove("active"),this.showFilterTypes())}populateFilterValues(e){const t=document.querySelector(".filter-values-list");if(t){t.innerHTML="";const a=this.availableOptions[e]||[];return 0===a.length?void(t.innerHTML="<div class=\"empty\">No data available</div>"):void a.forEach(a=>{const r=this.createFilterValueElement(e,a);t.appendChild(r)})}}createFilterOption(t,a,r){const i=document.createElement("label");i.className="option-item";const l=this.filterManager.isSelected(t,a.value);i.innerHTML=`
            <input type="checkbox" ${l?"checked":""} data-value="${a.value}">
            <span class="checkmark"></span>
            <span class="option-text">${this.escapeHtml(a.label)}</span>
            <span class="option-count">${this.formatNumber(a.count)}</span>
        `;const n=i.querySelector("input[type=\"checkbox\"]");return n.addEventListener("change",i=>{i.target.checked?this.filterManager.addFilter(t,a.value):this.filterManager.removeFilter(t,a.value),this.pendingChanges.add(t),"panel"===r?(this.setBackButtonApplyState(!0),this.updateFilterTypeStatus(t)):this.updateFilterSummary(t)}),i}createFilterValueElement(e,t){return this.createFilterOption(e,t,"panel")}filterValuesOptions(e,t){const a=document.querySelector(".filter-values-list");if(!a)return;const r=a.querySelectorAll(".option-item"),i=t.toLowerCase();r.forEach(e=>{const t=e.querySelector(".option-text").textContent.toLowerCase();e.style.display=t.includes(i)?"flex":"none"})}updateFilterTypeStatus(e){const t=document.querySelector(`[data-filter="${e}"]`),a=t?.querySelector(".filter-count");if(a){const t=this.filterManager.getActiveFilters()[e]||[];0===t.length?(a.textContent="All",a.style.background="rgba(255, 255, 255, 0.08)",a.style.color="rgba(255, 255, 255, 0.6)"):(a.textContent=t.length.toString(),a.style.background="rgba(124, 58, 237, 0.2)",a.style.color="rgba(124, 58, 237, 1)")}}initializeFilterLoadingState(){FILTER_TYPES.forEach(e=>{const t=document.querySelector(`[data-filter="${e}"] .options-list`);t&&(t.innerHTML="<div class=\"loading\">Loading options...</div>",t.classList.add("loading"))})}setupMultiSelectDropdowns(){const e=document.querySelectorAll(".multi-select-wrapper");e.forEach(e=>{const t=e.querySelector(".multi-select-trigger"),a=e.querySelector(".multi-select-dropdown"),r=e.dataset.filter;if(t&&a){t.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation();const i=a.classList.contains("show");if(closeAllModals(this),!i){a.classList.add("show"),t.classList.add("active"),e.classList.add("active");const r=a.querySelector(".search-input");r&&setTimeout(()=>r.focus(),100)}});const i=a.querySelector(".search-input");i&&i.addEventListener("input",t=>{this.filterOptions(r,t.target.value)});const l=a.querySelector(".select-all-btn"),n=a.querySelector(".clear-all-btn");l&&l.addEventListener("click",t=>{t.preventDefault(),this.selectAllOptions(r)}),n&&n.addEventListener("click",t=>{t.preventDefault(),this.clearAllOptions(r)})}}),document.addEventListener("click",t=>{t.target.closest(".multi-select-wrapper")||document.querySelectorAll(".multi-select-dropdown.show").forEach(e=>{e.classList.remove("show");const t=e.parentElement,a=t.dataset.filter;t.querySelector(".multi-select-trigger").classList.remove("active"),t.classList.remove("active"),this.pendingChanges.has(a)&&(this.pendingChanges.delete(a),this.filterManager.notifyChange())})})}setupFilterActions(){const e=document.querySelector(".clear-all-filters-btn");e&&e.addEventListener("click",t=>{t.preventDefault(),this.filterManager.clearAllFilters()})}populateFilterOptions(e){FILTER_TYPES.forEach(t=>{const a=e.metrics?.[`clicks_by_${t}`]||[];this.availableOptions[t]=a.map(e=>{if("country"===t){const a=this.getCountryName(e[t]);return{value:a,label:a,code:e[t],count:e.clicks||e.total_clicks||0}}if("short_code"===t){const a=e.short_code||e[t];return{value:a,label:a,count:e.clicks||e.total_clicks||0}}return{value:e[t],label:e[t],count:e.clicks||e.total_clicks||0}}).filter(e=>e.value).sort((e,t)=>t.count-e.count)}),this.updateAllFilterTypeStatuses()}updateAllFilterTypeStatuses(){FILTER_TYPES.forEach(e=>this.updateFilterTypeStatus(e))}renderFilterOptions(){FILTER_TYPES.forEach(e=>{const t=document.querySelector(`[data-filter="${e}"] .options-list`);if(t){t.innerHTML="",t.classList.remove("loading","empty");const a=this.availableOptions[e]||[];if(0===a.length)return t.innerHTML="<div class=\"empty\">No data available</div>",void t.classList.add("empty");a.forEach(a=>{const r=this.createOptionElement(e,a);t.appendChild(r)})}else console.warn(`Options list not found for ${e}`)})}createOptionElement(e,t){return this.createFilterOption(e,t,"dropdown")}filterOptions(e,t){const a=document.querySelector(`[data-filter="${e}"] .options-list`);if(!a)return;const r=a.querySelectorAll(".option-item"),i=t.toLowerCase();r.forEach(e=>{const t=e.querySelector(".option-text").textContent.toLowerCase();e.style.display=t.includes(i)?"flex":"none"})}updateFilterUI(){const e=this.filterManager.getTotalActiveFilters(),t=document.querySelector(".active-filters-count");t&&(0<e?(t.textContent=e,t.style.display="inline-block"):t.style.display="none"),FILTER_TYPES.forEach(e=>{this.updateFilterSummary(e),this.updateChartFilterIndicator(e)});const a=document.querySelector(".clear-all-filters-btn");a&&(a.disabled=0===e)}updateChartFilterIndicator(e){const t=this.filterManager.getActiveFilters()[e]||[],a=0<t.length,r={browser:"#browserChart",os:"#osChart",country:"#countryChart",city:"#cityChart",referrer:"#referrerChart",key:"#keyChart"}[e];if(r){const e=document.querySelector(r)?.closest(".chart-container");e&&e.setAttribute("data-has-active-filter",a.toString())}}updateFilterSummary(e){const t=document.querySelector(`[data-filter="${e}"] .multi-select-trigger`),a=t?.querySelector(".selected-summary");if(!a)return;const r=this.filterManager.getActiveFilters()[e]||[];if(0===r.length)a.textContent=`All ${{browser:"browsers",os:"systems",country:"countries",city:"cities",referrer:"referrers",short_code:"short URLs"}[e]}`,t.classList.remove("active");else if(1===r.length){const i=this.availableOptions[e].find(e=>e.value===r[0]);a.textContent=i?i.label:r[0],t.classList.add("active")}else if(3>=r.length){const i=r.map(t=>{const a=this.availableOptions[e].find(e=>e.value===t);return a?a.label:t});a.textContent=i.join(", "),t.classList.add("active")}else{const i=r.slice(0,2).map(t=>{const a=this.availableOptions[e].find(e=>e.value===t);return a?a.label:t});a.textContent=`${i.join(", ")} +${r.length-2}`,t.classList.add("active")}}setupCascadeControls(){document.querySelectorAll(".cascade-btn").forEach(t=>{t.addEventListener("click",a=>{if(t.disabled)return a.preventDefault(),void a.stopPropagation();a.stopPropagation();const e=t.nextElementSibling,r=e.classList.contains("show");closeAllModals(this),document.querySelectorAll(".cascade-dropdown").forEach(t=>{t!==e&&t.classList.remove("show")}),r?e.classList.remove("show"):e.classList.add("show")})}),document.querySelectorAll(".cascade-option").forEach(t=>{t.addEventListener("click",a=>{const e=t.closest(".cascade-select");if(e&&"none"===e.style.pointerEvents)return a.preventDefault(),void a.stopPropagation();const r=t.dataset.value,i=e.dataset.chart;e.querySelectorAll(".cascade-option").forEach(e=>{e.classList.remove("active")}),t.classList.add("active");const l=e.querySelector(".cascade-btn");l.dataset.value=r,l.querySelector("i").className=t.querySelector("i").className,l.title=t.querySelector("span").textContent,e.querySelector(".cascade-dropdown").classList.remove("show"),this.updateChartByType(i,r)})}),document.addEventListener("click",()=>{document.querySelectorAll(".cascade-dropdown").forEach(e=>{e.classList.remove("show")})})}setupTableViewControls(){document.querySelectorAll(".table-view-btn").forEach(t=>{t.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation();const e=t.dataset.chart;this.toggleTableView(e,t)})})}toggleTableView(e,t){const a=document.getElementById(e),r=document.getElementById(e.replace("Chart","Table")),i=document.querySelector(`[data-chart="${e}"].cascade-select`);if(a&&r){const l="none"!==r.style.display;l?this.fadeTransition(r,a,()=>{if(t.classList.remove("active"),t.title="Table View",i){i.style.pointerEvents="auto",i.style.opacity="1";const e=i.querySelector(".cascade-btn");e&&(e.disabled=!1)}}):this.fadeTransition(a,r,()=>{if(t.classList.add("active"),t.title="Chart View",i){i.style.pointerEvents="none",i.style.opacity="0.5";const e=i.querySelector(".cascade-btn");e&&(e.disabled=!0)}this.updateTableData(e)})}}fadeTransition(e,t,a){e.classList.add("chart-view-exit-active"),setTimeout(()=>{e.style.display="none",e.classList.remove("chart-view-exit-active"),t.style.display="block",t.classList.add("table-view-enter"),t.offsetHeight,t.classList.add("table-view-enter-active"),t.classList.remove("table-view-enter"),a&&a(),setTimeout(()=>{t.classList.remove("table-view-enter-active")},300)},150)}updateTableData(e){if(!this.apiData)return;const t=e.replace("Chart","Table"),a=document.getElementById(t+"Body");if(!a)return;a.innerHTML="";let r=[];return"timeSeriesChart"===e?r=this.getTimeSeriesTableData():"keyChart"===e?r=this.getKeyTableData():"cityChart"===e?r=this.getCityTableData():"browserChart"===e?r=this.getBrowserTableData():"osChart"===e?r=this.getOsTableData():"referrerChart"===e?r=this.getReferrerTableData():"countryChart"===e?r=this.getCountryTableData():void 0,0===r.length?void(a.innerHTML="<div class=\"table-empty\">No data available for the selected time range</div>"):void r.forEach(e=>{const t=document.createElement("div");t.className="table-row",t.innerHTML=`
                <div class="table-cell">${this.escapeHtml(e.label)}</div>
                <div class="table-cell">${this.formatNumber(e.clicks)}</div>
                <div class="table-cell">${this.formatNumber(e.unique_clicks)}</div>
            `,a.appendChild(t)})}getTimeSeriesTableData(){const e=this.apiData.metrics?.clicks_by_time||[],t=this.apiData.metrics?.unique_clicks_by_time||[];return e.map((e,a)=>({label:e.time||e.date||"Unknown",clicks:e.clicks||e.value||0,unique_clicks:t[a]?.unique_clicks||t[a]?.value||0}))}getKeyTableData(){const e=this.apiData.metrics?.clicks_by_short_code||[],t=this.apiData.metrics?.unique_clicks_by_short_code||[],a=new Map;return t.forEach(e=>{a.set(e.short_code,e.unique_clicks||e.value||0)}),e.map(e=>({label:e.short_code||"Unknown",clicks:e.clicks||e.value||0,unique_clicks:a.get(e.short_code)||0}))}getCityTableData(){const e=this.apiData.metrics?.clicks_by_city||[],t=this.apiData.metrics?.unique_clicks_by_city||[];return e.map((e,a)=>({label:e.city||"Unknown",clicks:e.clicks||e.value||0,unique_clicks:t[a]?.unique_clicks||t[a]?.value||0}))}buildTableData(e,t,{labelField:a,fallback:i="Unknown",labelTransform:r}={}){const l=this.apiData.metrics?.[e]||[],n=this.apiData.metrics?.[t]||[];return l.map((e,t)=>{const l=e[a],s=l||i,o=r?r(s,e):s,c=n[t]?.unique_clicks||n[t]?.value||0;return{label:o,clicks:e.clicks||e.value||0,unique_clicks:c}})}getBrowserTableData(){return this.buildTableData("clicks_by_browser","unique_clicks_by_browser",{labelField:"browser"})}getOsTableData(){return this.buildTableData("clicks_by_os","unique_clicks_by_os",{labelField:"os"})}getReferrerTableData(){return this.buildTableData("clicks_by_referrer","unique_clicks_by_referrer",{labelField:"referrer",fallback:"Direct"})}getCountryTableData(){return this.buildTableData("clicks_by_country","unique_clicks_by_country",{labelField:"country",labelTransform:(e,t)=>this.getCountryName(t.country)})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}addChartClickHandler(e,t){e&&e.canvas&&(e.canvas.onclick=a=>{const r=e.getElementsAtEventForMode(a,"nearest",{intersect:!0},!1);if(0<r.length){const a=r[0],i=e.data.labels[a.index];if("Others"===i)return;this.toggleChartFilter(t,i)}},e.canvas.onmousemove=t=>{const a=e.getElementsAtEventForMode(t,"nearest",{intersect:!0},!1);if(0<a.length){const t=a[0],r=e.data.labels[t.index];e.canvas.style.cursor="Others"===r?"default":"pointer"}else e.canvas.style.cursor="default"},e._filterType=t)}toggleChartFilter(e,t){const a=this.filterManager.isSelected(e,t);a?this.filterManager.removeFilter(e,t):this.filterManager.addFilter(e,t),this.updateFilterUI(),this.filterManager.notifyChange()}addMapClickHandler(e){e&&(e.listen("pointClick",t=>{const e=t.point;let a=null;try{if(a=e.get("id")||e.get("iso_a2")||e.get("code"),a){const e=this.getCountryName(a);e&&"Unknown"!==e&&this.toggleChartFilter("country",e)}else console.warn("Could not extract country code from map click")}catch(e){console.error("Error in map click handler:",e)}}),e.listen("pointMouseOver",()=>{try{const e=document.getElementById("countryChart");e&&(e.style.cursor="pointer")}catch(e){console.warn("Error setting cursor on mouse over:",e)}}),e.listen("pointMouseOut",()=>{try{const e=document.getElementById("countryChart");e&&(e.style.cursor="default")}catch(e){console.warn("Error setting cursor on mouse out:",e)}}))}updateChartByType(e,t){if(this.apiData){"timeSeriesChart"===e?this.updateTimeSeriesChart(this.apiData,t):"keyChart"===e?this.updateKeyChart(this.apiData,t):"cityChart"===e?this.updateCityChart(this.apiData,t):"browserChart"===e?this.updateBrowserChart(this.apiData,t):"osChart"===e?this.updateOsChart(this.apiData,t):"referrerChart"===e?this.updateReferrerChart(this.apiData,t):"countryChart"===e?this.updateCountryChart(this.apiData,t):void 0;const a=document.querySelector(`[data-chart="${e}"].table-view-btn`);a&&a.classList.contains("active")&&this.updateTableData(e)}}async loadDashboardData(){try{this.activeRequestController&&this.activeRequestController.abort(),this.activeRequestController=new AbortController;const{signal:e}=this.activeRequestController,t=new URLSearchParams({scope:"all",group_by:"time,browser,os,country,city,referrer,short_code",metrics:"clicks,unique_clicks"});let a,r;if(this.startDate&&this.endDate)a=new Date(this.startDate),r=new Date(this.endDate);else{const e=this.dateRangePicker.getCurrentRange();a=new Date(e.start),r=new Date(e.end)}t.append("start_date",a.toISOString()),t.append("end_date",r.toISOString());const i=Intl.DateTimeFormat().resolvedOptions().timeZone;t.append("timezone",i);const l=this.filterManager.getActiveFilters();Object.keys(l).forEach(e=>{const a=l[e];a&&0<a.length&&t.append(e,a.join(","))});const n=await fetch(`/api/v1/stats?${t.toString()}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"},signal:e});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);this.apiData=await n.json(),this.populateFilterOptions(this.apiData),this.updateDashboard(this.apiData)}catch(e){if("AbortError"===e.name)return;console.error("Error loading dashboard data:",e),this.showError("Failed to load dashboard data. Please try again.")}}updateDashboard(e){this.updateStatCards(e),this.updateCharts(e)}updateStatCards(e){const t=e.summary?.total_clicks||0,a=e.summary?.unique_clicks||0,r=0<t?(100*(a/t)).toFixed(1):0,i=e.summary?.avg_redirection_time||0;document.getElementById("totalClicks").textContent=this.formatNumber(t),document.getElementById("uniqueClicks").textContent=this.formatNumber(a),document.getElementById("clickRate").textContent=`${r}%`,document.getElementById("redirectionTime").textContent=this.formatNumber(i)+" ms"}updateChangeIndicator(e,t){const a=document.getElementById(e),r=0<t;a.textContent=`${r?"+":""}${t}${e.includes("Rate")?"%":""}`,a.className=`stat-change ${r?"positive":0>t?"negative":"neutral"}`}updateCharts(e){this.updateTimeSeriesChart(e),Object.keys(CHART_CONFIGS).forEach(t=>{"browser"===t?this.updateBrowserChart(e):"os"===t?this.updateOsChart(e):"referrer"===t?this.updateReferrerChart(e):"city"===t?this.updateCityChart(e):"short_code"===t?this.updateKeyChart(e):void 0}),this.updateCountryChart(e),document.querySelectorAll(".table-view-btn.active").forEach(e=>{const t=e.dataset.chart;this.updateTableData(t)})}updateCategoricalChart(e,t,a=null){const r=CHART_CONFIGS[e];if(!r)return void console.warn(`No chart config for type: ${e}`);const i=document.getElementById(r.id);if(!i)return;const l=i.getContext("2d");if(this.charts.has(e))try{this.charts.get(e).destroy()}catch(e){}const n=t.metrics?.[r.totalKey]||[],s=t.metrics?.[r.uniqueKey]||[],o=0<n.length||0<s.length;if(this.toggleEmptyState(r.id,!o),!o)return;const c=document.querySelector(`[data-chart="${r.id}"] .cascade-btn`)?.dataset.value,d=a||c||r.defaultMode,u=[];let p=[];const y=(e,t,a)=>{u.push({label:e,data:t,backgroundColor:a.bg,borderColor:a.border,borderWidth:2,borderRadius:20})};if("total"===d||"compare"===d){const e=this.processTopDataWithOthers(n,"clicks",r.metricBase);p=e.labels,y(r.totalLabel,e.values,r.colors.total)}if("unique"===d||"compare"===d)if(0===p.length){const e=this.processTopDataWithOthers(s,"unique_clicks",r.metricBase);p=e.labels,y(r.uniqueLabel,e.values,r.colors.unique)}else{const e=new Map;s.forEach(t=>{const a=t[r.metricBase]??"Unknown",i=t.unique_clicks??t.value??0;e.set(a,(e.get(a)??0)+i)});const t=p.map(t=>{if("Others"===t){let t=0;return e.forEach((e,a)=>{p.includes(a)||(t+=e)}),t}return e.get(t)??0});y(r.uniqueLabel,t,r.colors.unique)}const h={responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{ticks:{color:"#fff"},grid:{color:"rgba(255, 255, 255, 0.1)"}},y:{stacked:"compare"===d,ticks:{color:"#fff"},grid:{display:!1}}},plugins:{legend:{labels:{color:"#fff",boxWidth:12,boxHeight:12,useBorderRadius:!0,borderRadius:2,padding:20},position:"bottom",align:"start"},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.8)",titleColor:"#ffffff",bodyColor:"#ffffff"}}};r.tooltipAfterBody&&(h.plugins.tooltip.callbacks=h.plugins.tooltip.callbacks||{},h.plugins.tooltip.callbacks.afterBody=e=>r.tooltipAfterBody(e,{labels:p,datasets:u}));const b=new Chart(l,{type:"bar",data:{labels:p,datasets:u},options:h});this.addChartClickHandler(b,r.metricBase),this.charts.set(e,b)}updateTimeSeriesChart(e,t=null){const a=document.getElementById("timeSeriesChart"),r=a.getContext("2d");this.charts.has("timeSeries")&&this.charts.get("timeSeries").destroy();const i=e.metrics?.clicks_by_time||[],l=e.metrics?.unique_clicks_by_time||[],n=0<i.length||0<l.length;if(this.toggleEmptyState("timeSeriesChart",!n),!n)return;const s=e.time_bucket_info?.strategy||"daily",o=i.map(e=>e.time||e.date),c=o.map(e=>this.formatTimeLabel(e,s)),d=i.map(e=>void 0===e.clicks?e.value||0:e.clicks),u=l.map(e=>void 0===e.unique_clicks?e.value||0:e.unique_clicks),p=[],y=t||document.querySelector("[data-chart=\"timeSeriesChart\"] .cascade-btn")?.dataset.value||"compare";("total"===y||"compare"===y)&&p.push({label:"Total Clicks",data:d,fill:"start",backgroundColor:"rgba(139, 92, 246, 0.15)",borderColor:"rgba(139, 92, 246, 1)",borderWidth:2,tension:0}),("unique"===y||"compare"===y)&&p.push({label:"Unique Clicks",data:u,fill:"start",backgroundColor:"rgba(59, 130, 246, 0.2)",borderColor:"rgba(59, 130, 246, 1)",borderWidth:2,tension:0});const h=new Chart(r,{type:"line",data:{labels:c,datasets:p},options:{responsive:!0,maintainAspectRatio:!1,pointStyle:!1,scales:{x:{ticks:{color:"#fff",maxTicksLimit:8},grid:{color:"rgba(255,255,255,0.1)"}},y:{beginAtZero:!0,ticks:{color:"#fff",maxTicksLimit:10},grid:{color:"rgba(255,255,255,0.1)"}}},plugins:{legend:{labels:{color:"#fff",boxWidth:12,boxHeight:12,useBorderRadius:!0,borderRadius:2,padding:20},position:"bottom",align:"start"},tooltip:{backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#ffffff",bodyColor:"#ffffff",callbacks:{title:e=>{const t=e[0].dataIndex,a=c[t],r=o[t];if("hourly"===s||"10_minute"===s){const e=dayjs(r);return`${e.format("MMM D, YYYY")} at ${a}`}if("daily"===s){const e=dayjs(r);return`${a}, ${e.format("YYYY")}`}return a}}}}}});this.charts.set("timeSeries",h)}updateBrowserChart(e,t=null){this.updateCategoricalChart("browser",e,t)}updateOsChart(e,t=null){this.updateCategoricalChart("os",e,t)}updateReferrerChart(e,t=null){this.updateCategoricalChart("referrer",e,t)}updateCountryChart(e,t=null){const a=document.getElementById("countryChart");a.innerHTML="";const r=e.metrics?.clicks_by_country||[],i=e.metrics?.unique_clicks_by_country||[],l=0<r.length||0<i.length;if(this.toggleEmptyState("countryChart",!l),!l)return;const n=t||document.querySelector("[data-chart=\"countryChart\"] .cascade-btn")?.dataset.value||"total",s="unique"===n?i:r,o=s.map(e=>({id:e.country,value:e.clicks||e.unique_clicks}));var c=anychart.data.set(o),d=anychart.map();d.geoData("anychart.maps.world");var u=d.choropleth(c);u.colorScale(anychart.scales.linearColor("#2d1b3d","#8b5cf6","#a855f7","#c084fc")),u.stroke("#8b5cf6",1),u.hovered().fill(function(e){return anychart.color.darken(e.sourceColor,.1)}),u.tooltip().format(function(t){return"Clicks: <b>"+t.getData("value")+"</b>"});var p=d.title();p.enabled(!1),d.tooltip().useHtml(!0),d.colorRange().enabled(!0),d.colorRange().orientation("bottom"),d.colorRange().labels({fontSize:13,fontColor:"white"}),d.colorRange().stroke("",.5,"5 2","round");var y=d.grids();y.enabled(!0),y.stroke("rgba(255, 255, 255, 0.1)",.5,"10 2","round");var h=d.colorRange().marker();h.size(7),d.interactivity().zoomOnMouseWheel(!0),d.interactivity().keyboardZoomAndMove(!0),d.interactivity().zoomOnDoubleClick(!0);var b=anychart.ui.zoom();b.target(d),b.render(),d.container("countryChart"),d.contextMenu(!0),d.background().fill("rgba(255, 255, 255, 0)"),d.contextMenu().itemsFormatter(function(e){return delete e["full-screen-separator"],delete e.about,delete e["share-with"],delete e["print-chart"],e}),d.draw(),this.addMapClickHandler(d),this.charts.set("country",d)}updateCityChart(e,t=null){this.updateCategoricalChart("city",e,t)}updateKeyChart(e,t=null){this.updateCategoricalChart("short_code",e,t)}toggleEmptyState(e,t){const a=document.getElementById(`${e}-empty`),r=document.getElementById(e);a&&(t?(a.classList.remove("hidden"),r&&(r.style.display="none")):(a.classList.add("hidden"),r&&(r.style.display="")))}formatNumber(e){if(1e6<=e)return(e/1e6).toFixed(1)+"M";return 1e3<=e?(e/1e3).toFixed(1)+"K":e.toString()}setupAutoRefresh(){const e=document.querySelector(".auto-refresh-dropdown .dropdown-menu");e&&e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const a=t.target.closest(".dropdown-item");if(a&&!a.classList.contains("disabled")){const t=parseInt(a.dataset.interval);this.setAutoRefreshInterval(t);const r=document.querySelector(".auto-refresh-btn"),i=a.textContent.trim();r.innerHTML=`${i} <i class="ti ti-chevron-down"></i>`;e.classList.remove("show")}})}setAutoRefreshInterval(e){if(this.autoRefreshInterval&&(clearInterval(this.autoRefreshInterval),this.autoRefreshInterval=null),0<e?localStorage.setItem("stats-auto-refresh-interval",e.toString()):localStorage.removeItem("stats-auto-refresh-interval"),0<e){this.autoRefreshInterval=setInterval(()=>{this.loadDashboardData()},1e3*e)}}restoreAutoRefreshSetting(){const e=localStorage.getItem("stats-auto-refresh-interval");if(null!==e){const t=parseInt(e),a=document.querySelector(`[data-interval="${t}"]`);if(a){const e=document.querySelector(".auto-refresh-btn"),r=a.textContent.trim();e.innerHTML=`${r} <i class="ti ti-chevron-down"></i>`,this.setAutoRefreshInterval(t)}}}showError(e){console.error(e),alert(e)}destroy(){this.autoRefreshInterval&&clearInterval(this.autoRefreshInterval),this.charts.forEach(e=>{e.destroy?e.destroy():e.dispose&&e.dispose()}),this.charts.clear()}}function toggleView(e){const t="country"===e?document.getElementById(`${e}Chart`):document.getElementById(`${e}Chart`),a=document.querySelector(`.${e}JsonPre`),r=document.getElementById(`${e}Json`);t&&a&&r&&("none"===t.style.display?(t.style.display="block",a.style.display="none",r.style.display="none","country"===e&&(document.getElementById("country-container").style.padding="5px")):(t.style.display="none",a.style.display="block",r.style.display="block",window.dashboard&&window.dashboard.apiData&&(r.textContent=JSON.stringify(window.dashboard.apiData,null,2)),"country"===e&&(document.getElementById("country-container").style.padding="20px")))}function updateTimeSeriesChart(){window.dashboard&&window.dashboard.apiData&&window.dashboard.updateTimeSeriesChart(window.dashboard.apiData)}function updateBrowserChart(){window.dashboard&&window.dashboard.apiData&&window.dashboard.updateBrowserChart(window.dashboard.apiData)}function updateOsChart(){window.dashboard&&window.dashboard.apiData&&window.dashboard.updateOsChart(window.dashboard.apiData)}function updateReferrerChart(){window.dashboard&&window.dashboard.apiData&&window.dashboard.updateReferrerChart(window.dashboard.apiData)}function updateCountryChart(){window.dashboard&&window.dashboard.apiData&&window.dashboard.updateCountryChart(window.dashboard.apiData)}function updateCityChart(){window.dashboard&&window.dashboard.apiData&&window.dashboard.updateCityChart(window.dashboard.apiData)}function updateKeyChart(){window.dashboard&&window.dashboard.apiData&&window.dashboard.updateKeyChart(window.dashboard.apiData)}document.addEventListener("DOMContentLoaded",()=>{window.dashboard=new StatisticsDashboard,setupExportFunctionality(window.dashboard)}),window.closeAllModals=closeAllModals,window.addEventListener("beforeunload",()=>{window.dashboard&&window.dashboard.destroy()});class FilterManager{constructor(){this.activeFilters={browser:[],os:[],country:[],city:[],referrer:[],key:[]},this.onFiltersChanged=null}addFilter(e,t){this.activeFilters[e]||(this.activeFilters[e]=[]),this.activeFilters[e].includes(t)||this.activeFilters[e].push(t)}toggleFilter(e,t){this.activeFilters[e]||(this.activeFilters[e]=[]);const a=this.activeFilters[e].indexOf(t);-1<a?this.activeFilters[e].splice(a,1):this.activeFilters[e].push(t),this.notifyChange()}removeFilter(e,t){if(this.activeFilters[e]){const a=this.activeFilters[e].indexOf(t);-1<a&&this.activeFilters[e].splice(a,1)}}clearFilter(e){this.activeFilters[e]&&0<this.activeFilters[e].length&&(this.activeFilters[e]=[])}clearAllFilters(){Object.keys(this.activeFilters).forEach(e=>{this.activeFilters[e]=[]}),this.notifyChange()}isSelected(e,t){return this.activeFilters[e]&&this.activeFilters[e].includes(t)}getActiveFilters(){return{...this.activeFilters}}getTotalActiveFilters(){return Object.values(this.activeFilters).reduce((e,t)=>e+t.length,0)}notifyChange(){this.onFiltersChanged?this.onFiltersChanged():console.warn("FilterManager: onFiltersChanged callback not set")}saveToURL(){const e=new URL(window.location),t=e.searchParams;Object.keys(this.activeFilters).forEach(e=>{t.delete(e)}),Object.keys(this.activeFilters).forEach(e=>{0<this.activeFilters[e].length&&t.set(e,this.activeFilters[e].join(","))}),window.history.replaceState({},"",e)}loadFromURL(){const e=new URLSearchParams(window.location.search);let t=!1;return Object.keys(this.activeFilters).forEach(a=>{const r=e.get(a);r&&(this.activeFilters[a]=r.split(",").filter(e=>e.trim()),t=!0)}),t}}function setupExportFunctionality(t){function a(e){const a=new URLSearchParams({scope:"all",format:e});let l,n;if(t.startDate&&t.endDate)l=new Date(t.startDate),n=new Date(t.endDate);else{const e=t.dateRangePicker.getCurrentRange();l=new Date(e.start),n=new Date(e.end)}a.append("start_date",l.toISOString()),a.append("end_date",n.toISOString());const s=Intl.DateTimeFormat().resolvedOptions().timeZone;a.append("timezone",s),a.append("group_by","time,browser,os,country,city,referrer,short_code"),a.append("metrics","clicks,unique_clicks");const o=t.filterManager.getActiveFilters();Object.keys(o).forEach(e=>{const t=o[e];t&&0<t.length&&a.append(e,t.join(","))});const c=`/api/v1/export?${a.toString()}`;fetch(c,{credentials:"include",headers:{"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw new Error("Export failed");return e.blob()}).then(t=>{const a=window.URL.createObjectURL(t),l=document.createElement("a"),n="csv"===e?"zip":e,s=new Date().toISOString().split("T")[0];l.href=a,l.download=`spoo-me-stats-${s}.${n}`,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(a),i?.classList.remove("active"),r?.classList.remove("active")}).catch(e=>{console.error("Export error:",e),alert("Failed to export data. Please try again.")})}const r=document.querySelector(".export-btn"),i=document.getElementById("exportDropdownMenu");r?.addEventListener("click",function(a){a.preventDefault(),a.stopPropagation();const e=i.classList.contains("active");closeAllModals(t),e||(i.classList.add("active"),r.classList.add("active"))}),document.addEventListener("click",function(t){t.target.closest(".export-btn-wrapper")||(i?.classList.remove("active"),r?.classList.remove("active"))}),document.querySelectorAll(".export-menu-item").forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();const e=this.getAttribute("data-format");e&&a(e)})})}